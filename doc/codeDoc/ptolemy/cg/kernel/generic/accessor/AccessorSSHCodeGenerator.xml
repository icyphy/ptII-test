<?xml version="1.0" standalone="yes"?>
<!DOCTYPE doc PUBLIC "-//UC Berkeley//DTD DocML 1//EN"
    "http://ptolemy.eecs.berkeley.edu/xml/dtd/DocML_1.dtd">
<doc name="AccessorSSHCodeGenerator" class="ptolemy.cg.kernel.generic.accessor.AccessorSSHCodeGenerator">
  <description>
Generate a JavaScript composite accessor for a model and deploy&#10;  it to a remote host.&#10;&#10;  &lt;p&gt;Accessors are a technology, developed by the&#10;  &lt;a href=&quot;http://www.terraswarm.org#in_browser&quot; target=&quot;_top&quot;&gt;TerraSwarm Research Center&lt;/a&gt;,&#10;  for composing heterogeneous devices and services in the&#10;  Internet of Things (IoT).  For more information, see&#10;  &lt;a href=&quot;http://accessors.org#in_browser&quot; target=&quot;_top&quot;&gt;http://accessors.org&lt;/a&gt;.&lt;/p&gt;&#10;&#10;  &lt;p&gt;The model can only contain JavaScript and JSAccessor actors.&lt;/p&gt;&#10;&#10;  &lt;p&gt;To generate an Accessor version of a model, use:&lt;/p&gt;&#10;  &lt;pre&gt;&#10;  java -classpath $PTII ptolemy.cg.kernel.generic.accessor.AccessorSSHCodeGenerator -language accessor $PTII/ptolemy/cg/kernel/generic/accessor/demo/TestComposite/TestComposite.xml; cat $PTII/org/terraswarm/accessor/accessors/web/hosts/node/TestComposite.js&#10;  &lt;/pre&gt;&#10;  which is shorthand for:&#10;  &lt;pre&gt;&#10;  java -classpath $PTII ptolemy.cg.kernel.generic.accessor.AccessorSSHCodeGenerator -generatorPackage ptolemy.cg.kernel.generic.accessor -generatorPackageList generic.accessor $PTII/ptolemy/cg/adapter/generic/accessor/adapters/org/test/auto/TestComposite.xml; cat ~/cg/TestComposite.js&#10;  &lt;/pre&gt;&#10;&#10;  To use Cape Code, invoke:&#10;  &lt;pre&gt;&#10;  $PTII/bin/vergil -capecode $PTII/ptolemy/cg/kernel/generic/accessor/test/auto/RampJSTextDisplay.xml&#10;  &lt;/pre&gt;&#10;&#10;  &lt;p&gt;This actor runs $PTII/ptolemy/cg/kernel/generic/accessor/accessorInvokeSSH, which does the following on the remote machine:&lt;/p&gt;&#10;  &lt;ol&gt;&#10;&#10;    &lt;li&gt;Creates a directory in &lt;code&gt;~/cg/&lt;i&gt;ModelName&lt;/i&gt;&lt;/code&gt;,&#10;    for example &lt;code&gt;~/cg/MyCompositeAccessor&lt;/code&gt;&lt;/li&gt;&#10;&#10;    &lt;li&gt;Installs the &lt;code&gt;@terraswarm/accessors&lt;/code&gt; and&#10;      &lt;code&gt;pm2&lt;/code&gt; modules in&#10;      &lt;code&gt;~/cg/&lt;i&gt;ModelName&lt;/i&gt;&lt;/code&gt;. Note&#10;      that this means that to run a composite accessor with the&#10;      latest accessors, the npm &lt;code&gt;@terraswarm/accessors&lt;/code&gt;&#10;      module must be updated.  See&#10;      &lt;a href=&quot;https://accessors.org/wiki/Main/NPMUpload&quot;&gt;NPM Upload&lt;/a&gt;&#10;      in the accessors Wiki.&#10;      In addition, any modules listed in the comma-separated&#10;      &lt;i&gt;modules&lt;/i&gt; parameter are also installed.  &lt;/li&gt;&#10;&#10;    &lt;li&gt;Creates a small node script called &lt;code&gt;invoke.js&lt;/code&gt; to&#10;    run the composite accessor.&lt;/li&gt;&#10;&#10;    &lt;li&gt;Copies the composite accessor to the directory.&lt;/li&gt;&#10;&#10;    &lt;li&gt;Creates a script called &lt;code&gt;runit&lt;/code&gt; that uses&#10;    &lt;a href=&quot;http://pm2.keymetrics.io/&quot;&gt;pm2&lt;/a&gt;&#10;    to stop any processes with the same name as the accessor&#10;    started with forever name and then invokes node on the remote&#10;    machine using &lt;code&gt;pm2&lt;/code&gt;.  If the director of the model&#10;    has a &lt;i&gt;stopTime&lt;/i&gt; parameter, then the value is multiplied by&#10;    1000 and used as the value of the timeout parameter on the&#10;    remote machine. If the &lt;i&gt;stopTime&lt;/i&gt; parameter is not set,&#10;    then a default value (currently 15000 ms.)  is used.&lt;/li&gt;&#10;&#10;    &lt;li&gt;The stderr and stdout are then&#10;    reported using tail&lt;/li&gt;&#10;&#10;   &lt;/ol&gt;&#10;&#10;  &lt;p&gt;The &lt;code&gt;accessorInvokeSSH&lt;/code&gt; script should work on any&#10;  machine that has node and npm installed.&lt;/p&gt;&#10;&#10;  &lt;p&gt; &lt;a href=&quot;http://pm2.keymetrics.io/&quot;&gt;pm2&lt;/a&gt; is a Node package&#10;  installed using npm that can run a process forever and can cause&#10;  it to be started upon reboot. &lt;b&gt;Note that for the process to be started&#10;  after reboot&lt;/b&gt;, a command needs to be run once as root on the host machine.&#10;  The command is displayed during code generation.  The command is specific&#10;  to the user account on the remote machine.&#10;  &lt;/p&gt;&#10;&#10;&#10;  &lt;p&gt;To use a SwarmBox, add your &lt;code&gt;~/.ssh/id_rsa.pub&lt;/code&gt; file&#10;  to &lt;code&gt;swarmboxadmin/ansible/keys/sbuser_authorized_keys&lt;/code&gt;.&#10;  See &lt;a href=&quot;https://www.terraswarm.org/testbeds/wiki/Main/SbuserSSHAccess#in_browser&quot;&gt;https://www.terraswarm.org/testbeds/wiki/Main/SbuserSSHAccess&lt;/a&gt;.&lt;/p&gt;&#10;&#10;  &lt;p&gt;For more information, see the&#10;  &lt;a href=&quot;https://accessors.org/wiki/Main/CapeCodeHost#CodeGeneration&quot;&gt;Code Generation wiki&lt;/a&gt;.&lt;/p&gt;  </description>
  <author>Christopher Brooks.  Based on HTMLCodeGenerator by Man-Kit Leung, Bert Rodiers</author>
  <version>$Id$</version>
  <since>Ptolemy II 11.0</since>
  <Pt.ProposedRating>red (cxh)</Pt.ProposedRating>
  <Pt.AcceptedRating>red (cxh)</Pt.AcceptedRating>
    <!--ptolemy.data.expr.Parameter-->
    <property name="runForever">If true, then use npm forever to run the Node composite&#10;  accessor forever.  If false, then run until &lt;i&gt;stopTime&lt;/i&gt;&#10;  ms. has passed.  Note that if true, then the process will be&#10;  restarted after &lt;i&gt;stopTime&lt;/i&gt; ms. or until the code&#10;  generator is run with &lt;i&gt;stopForeverAccessors&lt;/i&gt; is true or&#10;  the remote machine is rebooted.  The default value is true,&#10;  indicating that the process should be run forever.</property>
    <!--ptolemy.data.expr.Parameter-->
    <property name="stopForeverAccessors">If true, then connect to the remote machine and stop any npm&#10;  forever processes with the same basename as the model.&#10;  Confusingly, to stop any remote processes that have been&#10;  previously invoked, &lt;i&gt;run&lt;/i&gt; should be true so that the&#10;  &lt;code&gt;accessorInvokeSSH&lt;/code&gt; script is invoked on the remote&#10;  machine with a &lt;code&gt;stop&lt;/code&gt; argument.&#10;  The default value is false, indicating that&#10;  the remote machine will invoke the Node accessor host&#10;  composite accessor.</property>
    <!--ptolemy.data.expr.StringParameter-->
    <property name="userHost">The username and hostname that is used with ssh.&#10;  The default value is &quot;sbuser@swarmnuc001.eecs.berkeley.edu&quot;.&#10;  To get ssh access, see&#10;  &lt;a href=&quot;https://www.terraswarm.org/testbeds/wiki/Main/SbuserSSHAccess#in_browser&quot;&gt;https://www.terraswarm.org/testbeds/wiki/Main/SbuserSSHAccess&lt;/a&gt;.</property>
</doc>
